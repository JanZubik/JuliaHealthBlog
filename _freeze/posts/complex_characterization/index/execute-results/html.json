{
  "hash": "148fe27fbc0601d3cc42e5747213b05a",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Exploring Anthracyclines and Disease within an OMOP CDM Database\"\ndescription: \"An overview of how to use the observational health tools within JuliaHealth to explore the usage of various Anthracyclines alongside diseases of interest.\"\nauthor: \"Jacob S. Zelko\"\ndate: \"6/23/2024\"\ntoc: true\ncategories:\n  - cardiovascular disease\n  - omop cdm\n  - observational health\n  - cancer\n---\n\n\n\n# Background\n\nThis is a small sample notebook I threw together to illustrate how to further build a small characterization study when exploring drugs and conditions of interest.\nIt goes into a bit more depth on how to find drugs and diseases folks are interested in.\n\n# Set-Up\n\nLoading required packages\n\n::: {#efa20891 .cell execution_count=2}\n``` {.julia .cell-code}\nusing JSON3\nusing HTTP\nusing OMOPCDMCohortCreator\n\nimport DBInterface:\n    connect,\n    execute\nimport LibPQ:\n    Connection\n```\n:::\n\n\nCreating connection to database\n\n::: {#c6f3bcad .cell execution_count=3}\n``` {.julia .cell-code}\nconn = connect(\n    Connection, \n    \"user=thecedarprince dbname=synthea\"\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=30}\n```\nPostgreSQL connection (CONNECTION_OK) with parameters:\n  user = thecedarprince\n  passfile = /home/thecedarprince/.pgpass\n  channel_binding = prefer\n  dbname = synthea\n  port = 5432\n  client_encoding = UTF8\n  options = -c DateStyle=ISO,YMD -c IntervalStyle=iso_8601 -c TimeZone=UTC\n  application_name = LibPQ.jl\n  sslmode = prefer\n  sslcompression = 0\n  sslsni = 1\n  ssl_min_protocol_version = TLSv1.2\n  gssencmode = prefer\n  krbsrvname = postgres\n  target_session_attrs = any\n```\n:::\n:::\n\n\nGenerating database details for the synthetic database we are connecting to (this is used internally by the `OMOPCDMCohortCreator.jl` packag):\n\n::: {#3e69d2bc .cell execution_count=4}\n``` {.julia .cell-code}\nGenerateDatabaseDetails(:postgresql, \"omop\")\nGenerateTables(conn)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n[ Info: Global database dialect set to: postgresql\n[ Info: Global schema set to: omop\n[ Info: source_to_concept_map table generated internally\n[ Info: payer_plan_period table generated internally\n[ Info: vocabulary table generated internally\n[ Info: note_nlp table generated internally\n[ Info: procedure_occurrence table generated internally\n[ Info: domain table generated internally\n[ Info: metadata table generated internally\n[ Info: cohort_summary_stats table generated internally\n[ Info: fact_relationship table generated internally\n[ Info: drug_exposure table generated internally\n[ Info: all_visits table generated internally\n[ Info: final_visit_ids table generated internally\n[ Info: person table generated internally\n[ Info: cost table generated internally\n[ Info: observation table generated internally\n[ Info: provider table generated internally\n[ Info: visit_detail table generated internally\n[ Info: assign_all_visit_ids table generated internally\n[ Info: device_exposure table generated internally\n[ Info: measurement table generated internally\n[ Info: source_to_standard_vocab_map table generated internally\n[ Info: location table generated internally\n[ Info: visit_occurrence table generated internally\n[ Info: relationship table generated internally\n[ Info: dose_era table generated internally\n[ Info: concept table generated internally\n[ Info: death table generated internally\n[ Info: concept_class table generated internally\n[ Info: drug_era table generated internally\n[ Info: note table generated internally\n[ Info: episode_event table generated internally\n[ Info: episode table generated internally\n[ Info: specimen table generated internally\n[ Info: condition_occurrence table generated internally\n[ Info: cohort_inclusion table generated internally\n[ Info: cohort table generated internally\n[ Info: concept_ancestor table generated internally\n[ Info: cohort_inclusion_stats table generated internally\n[ Info: cohort_inclusion_result table generated internally\n[ Info: observation_period table generated internally\n[ Info: condition_era table generated internally\n[ Info: concept_relationship table generated internally\n[ Info: cohort_censor_stats table generated internally\n[ Info: concept_synonym table generated internally\n[ Info: cdm_source table generated internally\n[ Info: cohort_definition table generated internally\n[ Info: drug_strength table generated internally\n[ Info: source_to_source_vocab_map table generated internally\n[ Info: care_site table generated internally\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=31}\n```\nPostgreSQL connection (CONNECTION_OK) with parameters:\n  user = thecedarprince\n  passfile = /home/thecedarprince/.pgpass\n  channel_binding = prefer\n  dbname = synthea\n  port = 5432\n  client_encoding = UTF8\n  options = -c DateStyle=ISO,YMD -c IntervalStyle=iso_8601 -c TimeZone=UTC\n  application_name = LibPQ.jl\n  sslmode = prefer\n  sslcompression = 0\n  sslsni = 1\n  ssl_min_protocol_version = TLSv1.2\n  gssencmode = prefer\n  krbsrvname = postgres\n  target_session_attrs = any\n```\n:::\n:::\n\n\n# Creating Drug and Disease Look-Ups\n\nHere are the anthracyclines we are exploring:\n\n::: {#a7a877de .cell execution_count=5}\n``` {.julia .cell-code}\ndrugs = [\n    (name = \"Daunorubicin\", id = 1311799),\n    (name = \"Doxorubicin\", id = 1338512),\n    (name = \"Epirubicin\", id = 1344354),\n    (name = \"Idarubicin\", id = 19078097),\n    (name = \"Mitoxantrone\", id = 1309188),\n    (name = \"Valrubicin\", id = 19012543),\n    (name = \"Ibrutinib\", id = 44507848),\n    (name = \"Acalabrutinib\", id = 792764),\n    (name = \"Zanubrutinib\", id = 37497691),\n]\n```\n\n::: {.cell-output .cell-output-display execution_count=32}\n```\n9-element Vector{@NamedTuple{name::String, id::Int64}}:\n (name = \"Daunorubicin\", id = 1311799)\n (name = \"Doxorubicin\", id = 1338512)\n (name = \"Epirubicin\", id = 1344354)\n (name = \"Idarubicin\", id = 19078097)\n (name = \"Mitoxantrone\", id = 1309188)\n (name = \"Valrubicin\", id = 19012543)\n (name = \"Ibrutinib\", id = 44507848)\n (name = \"Acalabrutinib\", id = 792764)\n (name = \"Zanubrutinib\", id = 37497691)\n```\n:::\n:::\n\n\nHere are the diseases we are exploring:\n\n::: {#8776cacb .cell execution_count=6}\n``` {.julia .cell-code}\ndiseases = [\n    (name = \"Myocardial Infarction\", id = 4329847),\n    (name = \"Heart Failure\", id = 316139),\n]\n```\n\n::: {.cell-output .cell-output-display execution_count=33}\n```\n2-element Vector{@NamedTuple{name::String, id::Int64}}:\n (name = \"Myocardial Infarction\", id = 4329847)\n (name = \"Heart Failure\", id = 316139)\n```\n:::\n:::\n\n\nFor both these drugs and diseases, the IDs come from [ATLAS](https://atlas-demo.ohdsi.org/#/search), a tool to develop computable phenotype definitions (i.e. translating a disease phenotype definition to the same thing but in code).\nHow these IDs were found for a drug is as follows (using Doxorubicin as an example):\n\n1. Search within ATLAS for Doxorubicin.\n\n2. Click any Doxorubicin-related drug name.\n\n3. Look through the related concepts or hierarchy (in the parent section) for the ingredient version of the drug.\n\n4. Copy that ID for the ingredient version of Doxorubicin.\n\nThat is the ID we used here as it is the base for all other Doxorubicin medications.\n\nNext, we can do something similar for Myocardial Infarction:\n\n1. Search within ATLAS for Myocardial Infarction.\n\n2. Click any Myocardial Infarction-related name.\n\n3. Look through the hierarchy of this disease. \nThe condition version we are looking for is that parent concepts are too broad for our condition and the current condition we select should have children that encompass all diseases we want (in this case, this is [recorded condition](https://atlas-demo.ohdsi.org/#/concept/4329847) is the perfect level of granularity).\n\n4. Copy that ID for the ingredient version of Myocardial Infarction.\n\nThat is the ID we used here as it is the base for all other Myocardial Infarction-related disease conditions.\n\nNext, we'll discuss how to create a query that includes the derivatives of the general concepts for the drugs and diseases we found.\n\n# Generating Ad Hoc Phenotype Definitions\n\nHere, we programmatically query the public ATLAS instance that is running to get the children IDs of the general concepts (referred to as descendants in ATLAS).\nIn this case, we are, in a very ad hoc way, creating an implicit computable phenotype definition where we are looking for all drugs and diseases that are based off our general concepts.\nThis is great for rapid prototyping, but a phenotype definition must be scrutinized ruthlessly when moving towards a final version for patient analysis (see: [Zelko, Jacob S., et al. \"Developing a Robust Computable Phenotype Definition Workflow to Describe Health and Disease in Observational Health Research.\" arXiv preprint arXiv:2304.06504 (2023).](https://arxiv.org/abs/2304.06504) which discussed more about this process).\n\nThis is how we do that for drugs:\n\n::: {#78562127 .cell execution_count=7}\n``` {.julia .cell-code}\ndrug_descendants = []\nfor drug in drugs\n    path = \"https://atlas-demo.ohdsi.org/WebAPI/vocabulary/ATLASPROD/concept/$(drug.id)/descendants/\"\n    descendants = \n        HTTP.get(path) |> \n        x -> String(x.body) |> \n        JSON3.read\n    push!(drug_descendants, descendants)\nend\n```\n:::\n\n\nThis is how we do that for diseases:\n\n::: {#fb2d06bf .cell execution_count=8}\n``` {.julia .cell-code}\ndisease_descendants = []\nfor disease in diseases\n    path = \"https://atlas-demo.ohdsi.org/WebAPI/vocabulary/ATLASPROD/concept/$(disease.id)/descendants/\"\n    descendants = \n        HTTP.get(path) |> \n        x -> String(x.body) |> \n        JSON3.read\n    push!(disease_descendants, descendants)\nend\n```\n:::\n\n\n# Analyzing the OMOPCDM Database\n\nFind users of the drugs we are interested in:\n\n::: {#ed938d6b .cell execution_count=9}\n``` {.julia .cell-code}\ndrug_users = Dict()\nfor (idx, drug) in enumerate(drugs)\n    ids = OMOPCDMCohortCreator.DrugExposureFilterPersonIDs(\n        [\n            drug[:CONCEPT_ID] \n            for drug in drug_descendants[idx]\n        ], conn).person_id\n    push!(\n        drug_users, \n        drug.name => \n            (ids = ids, count = length(ids))\n    )\nend\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\n```\n:::\n:::\n\n\nFind patients diagnosed with the conditions we are interested in:\n\n::: {#bff1c9f9 .cell execution_count=10}\n``` {.julia .cell-code}\ndiseased_patients = Dict()\nfor (idx, disease) in enumerate(diseases)\n    ids = ConditionFilterPersonIDs(\n        [\n            d[:CONCEPT_ID] \n            for d in disease_descendants[idx]\n            ], conn).person_id\n    push!(\n        diseased_patients, \n        disease.name => \n            (ids = ids, count = length(ids))\n        )\nend\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\nWARNING:  database \"synthea\" has a collation version mismatch\nDETAIL:  The database was created using collation version 2.37, but the operating system provides version 2.38.\nHINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE synthea REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.\n```\n:::\n:::\n\n\nFind the combination of patients diagnosed with the conditions we are interested in and taking the drugs we want to investigate:\n\n::: {#76127f7e .cell execution_count=11}\n``` {.julia .cell-code}\ncondition_mix = Dict()\nfor pg in keys(diseased_patients)\n    push!(condition_mix, pg => Dict())\n    for du in keys(drug_users)\n        mix = intersect(\n            diseased_patients[pg].ids, \n            drug_users[du].ids\n        )\n        push!(\n            condition_mix[pg], \n            du => (ids = mix, count = length(mix))\n        )\n    end\nend\n```\n:::\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {}
  }
}